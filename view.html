<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>
<body>
<input type="file" id="fileSelector" multiple/>

<button id="submit" class="green" onclick="loadReport();">Parse</button>

<div class="accordion">
    <h3>Users is queue</h3>
    <div id="usersInQueue"></div>
</div>

<div class="accordion">
    <h3>Active users (queue + in game)</h3>
    <div id="activeUsers"></div>
</div>

<div class="accordion">
    <h3>Games created (total)</h3>
    <div id="gamesCreated"></div>
</div>

<div class="accordion">
    <h3>Real skill level distribution</h3>
    <div id="skillLevelDistr"></div>
</div>

<div class="accordion">
    <h3>Time in queue (avg)</h3>
    <div id="timeInQueue"></div>
</div>

<div class="accordion">
    <h3>Time in queue (max)</h3>
    <div id="timeInQueueMax"></div>
</div>

<div class="accordion">
    <h3>Game created average team skill delta</h3>
    <div id="gameCreatedTeamSkill"></div>
</div>

<div class="accordion">
    <h3>Game created max skill delta</h3>
    <div id="gameCreatedMaxSkillDelta"></div>
</div>

<div class="accordion">
    <h3>Game created team real skill delta</h3>
    <div id="gameCreatedTeamRealSkill"></div>
</div>

<div class="accordion">
    <h3>Game created min/max real skill delta</h3>
    <div id="gameCreatedMaxRealSkillDelta"></div>
</div>

<div class="accordion">
    <h3>Average skill level error of all users</h3>
    <div id="avgSkillError"></div>
</div>


<script>
    $(".accordion").accordion({
        collapsible: true,
        active: false
    });

    var usersInQueueChart = undefined;
    var activeUsersChart = undefined;
    var gamesCreatedChart = undefined;

    var skillLevelDistr = undefined;

    var timeInQueueChart = undefined;
    var timeInQueueMaxChart = undefined;

    var gameCreatedTeamSkill = undefined;
    var gameCreatedMaxSkillDelta = undefined;

    var gameCreatedTeamRealSkill = undefined;
    var gameCreatedMaxRealSkillDelta = undefined;

    var avgSkillError = undefined;

    google.charts.load('current', {'packages': ['corechart']});
    google.charts.setOnLoadCallback(onLoad);

    function onLoad() {
         usersInQueueChart = createLinearDiagram('usersInQueue', true, 50.0);
         activeUsersChart = createLinearDiagram('activeUsers', true, 1000.0);
         gamesCreatedChart = createLinearDiagram('gamesCreated', true);

         skillLevelDistr = createLinearDiagram('skillLevelDistr', true);

         timeInQueueChart = createLinearDiagram('timeInQueue', true, 100.0);
         timeInQueueMaxChart = createLinearDiagram('timeInQueueMax', true, 100.0);

         gameCreatedTeamSkill = createLinearDiagram('gameCreatedTeamSkill', true, 1000.0);
         gameCreatedMaxSkillDelta = createLinearDiagram('gameCreatedMaxSkillDelta', true, 1000.0);

         gameCreatedTeamRealSkill = createLinearDiagram('gameCreatedTeamRealSkill', true, 1000.0);
         gameCreatedMaxRealSkillDelta = createLinearDiagram('gameCreatedMaxRealSkillDelta', true, 1000.0);

         avgSkillError = createLinearDiagram('avgSkillError', true, 100.0);
    }

    function createLinearDiagram(id, showLines, suggestedMax) {
        var chart = new google.visualization.LineChart(document.getElementById(id));

        return chart;
    }

    function loadReport() {
        var files = $('#fileSelector')[0].files;
        if (files.length == 0) {
            alert("No reports selected");
            return;
        }

        for (var i = 0; i < files.length; i++) {
            Papa.parse(files[i], {
                complete: function (results, file) {
                    loadData(results.data);
                }
            });
        }
    }

    function filterData(label, data, key) {
        var dataSet = createEmptyDataSet(label);

        var min = 1.0 / 0.0;
        var max = 0.0;
        var sum = 0.0;
        var count = 0;

        for (var i = 0; i < data.length; i++) {
            var row = data[i];
            if (key != row[1]) {
                continue;
            }

            var xValue = parseInt(row[0]);
            var yValue = parseFloat(row[2]);

            dataSet.addRow([xValue, yValue]);

            count += 1.0;
            sum += yValue;
            if (min == undefined || min > yValue) {
                min = yValue;
            }
            if (max == undefined || max < yValue) {
                max = yValue;
            }

        }

        var stats = "(min:" + fmt(min) + ",max:" + fmt(max) + ",avg:" + fmt(sum / count) + ")";
//        dataSet.label = label + stats;

        return dataSet;
    }

    function fmt(original) {
        return Math.round(original * 100) / 100;
    }

    function findParam(name, data) {
        for (var i = 0; i < data.length; i++) {
            var row = data[i];

            if (row[0] == name) {
                return row[1];
            }

            if (row[0] > 0) {
                console.log("Unable to find param: " + name);
            }
        }

        return undefined;
    }

    function filterAsOccSum(label, data, key, dataIndex, sample) {
        if (sample == undefined) {
            sample = 1.0;
        }

        var rawData = [];
        for (var i = 0; i < data.length; i++) {
            var row = data[i];
            if (key != row[0]) {
                continue;
            }

            var index = Math.round(row[dataIndex] / sample);
            if (rawData[index] == undefined) {
                rawData[index] = 1;
            } else {
                rawData[index] = rawData[index] + 1;
            }
        }


        var dataSet = createEmptyDataSet(label);
        for (i = 0; i < rawData.length; i++) {
            var xValue = i * sample;
            var yValue = rawData[i];

            var dataObj = {x: xValue, y: yValue};
            dataSet.addRow([xValue, yValue]);
        }

        return dataSet;
    }

    function createEmptyDataSet(label) {
        var mainColor = color(label);

        var data = new google.visualization.DataTable();
        data.addColumn("number", "time");
        data.addColumn("number", "value");

        return data;
    }

    function loadDiagram(dataSet, chart) {
        var options = {
            title: 'Title',
            curveType: 'function',
            legend: { position: 'bottom' }
        };
        chart.draw(dataSet);
    }

    function loadData(data) {
        var name = findParam("name", data);
        console.log("Loading data:" + name);

        loadDiagram(filterData(name, data, "users_in_queue"), usersInQueueChart);
        loadDiagram(filterData(name, data, "active_users"), activeUsersChart);
        loadDiagram(filterData(name, data, "games_created"), gamesCreatedChart);

        //        loadDiagram(filterAsOccSum(name, data, "user_generated_skill", 1, 5), skillLevelDistr);

        loadDiagram(filterData(name, data, "time_in_queue_avg"), timeInQueueChart);
        loadDiagram(filterData(name, data, "time_in_queue_max"), timeInQueueMaxChart);

        loadDiagram(filterData(name, data, "game_created_avg_skill_delta"), gameCreatedTeamSkill);
        loadDiagram(filterData(name, data, "game_created_max_skill_delta"), gameCreatedMaxSkillDelta);

        loadDiagram(filterData(name, data, "game_created_avg_rskill_delta"), gameCreatedTeamRealSkill);
        loadDiagram(filterData(name, data, "game_created_max_rskill_delta"), gameCreatedMaxRealSkillDelta);
        loadDiagram(filterData(name, data, "avg_skill_error"), avgSkillError);

        console.log("Finishing load of:" + name);
    }

    // samplers
    function avg(values) {
        var sum = 0;
        for (var i = 0; i < values.length; i++) {
            sum += values[i];
        }
        return Math.round(sum / values.length);
    }

    function delta(values) {
        if (values.length <= 1) {
            return 0;
        }

        return result;
    }

    function color(str) {
        var hash = 0;
        for (var i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }

        var r = (hash & 0xFF0000) >> 16;
        var g = (hash & 0x00FF00) >> 8;
        var b = hash & 0x0000FF;

        return "rgba(" + r + "," + g + "," + b + ",1.0)";
    }

</script>
</body>
</html>
