<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.3.0/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.2/papaparse.min.js"></script>
</head>
<body>
<input type="file" id="fileSelector" multiple/>

<button id="submit" class="green" onclick="loadReport();">Parse</button>

<div class="accordion">
    <h3>Users is queue</h3>
    <canvas id="usersInQueue"></canvas>
</div>

<div class="accordion">
    <h3>Games created</h3>
    <canvas id="gamesCreated"></canvas>
</div>


<script>
    $(".accordion").accordion({
        collapsible: true,
        active: false
    });

    var usersInQueueChart = createLinearDiagram('#usersInQueue');
    var gamesCreatedChart = createLinearDiagram('#gamesCreated');

    var loadingConfig = {
        delimiter: "",	// auto-detect
        newline: "",	// auto-detect
        header: false,
        dynamicTyping: true,
        preview: 0,
        encoding: "",
        worker: false,
        comments: false,
        step: undefined,
        complete: function (results, file) {
            loadData(results.data);
        },
        error: undefined,
        download: false,
        skipEmptyLines: false,
        chunk: undefined,
        fastMode: undefined,
        beforeFirstChunk: undefined,
        withCredentials: undefined,
    };

    function createLinearDiagram(id) {
        return new Chart($(id), {
            type: 'line',
            data: {
                datasets: [],
                labels: []
            },
            options: {
                title: {
                    display: false
                },
                scales: {
                    xAxes: [{
                        type: 'linear',
                        position: 'bottom'
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }

    function loadReport() {
        var files = $('#fileSelector')[0].files;
        if (files.length == 0) {
            alert("No reports selected");
            return;
        }

        for (var i = 0; i < files.length; i++) {
            Papa.parse(files[i], loadingConfig);
        }
    }

    function filterData(data, dataset, key, dataIndex) {
        for (var i = 0; i < data.length; i++) {
            var row = data[i];

            var tick = row[0];
            if (row [1] == key) {
                var dataObj = {x: tick, y: row[dataIndex]};
                dataset.data.push(dataObj);
            }
        }
    }

    function createDataSet() {
        return {
            fill: false,
            lineTension: 0.1,
            backgroundColor: "rgba(75,192,192,0.4)",
            borderColor: "rgba(75,192,192,1)",
            borderCapStyle: 'butt',
            borderDash: [],
            borderDashOffset: 0.0,
            borderJoinStyle: 'miter',
            pointBorderColor: "rgba(75,192,192,1)",
            pointBackgroundColor: "#fff",
            pointBorderWidth: 1,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "rgba(75,192,192,1)",
            pointHoverBorderColor: "rgba(220,220,220,1)",
            pointHoverBorderWidth: 2,
            pointRadius: 1,
            pointHitRadius: 10,
            data: []
        };
    }

    function loadDiagram(data, chart, key, dataIndex) {
        var dataSet = createDataSet();
        filterData(data, dataSet, key, dataIndex);

        chart.data.datasets.push(dataSet);
        chart.update();
    }

    function loadData(data) {
        loadDiagram(data, usersInQueueChart, "users_in_queue", 2);
        loadDiagram(data, gamesCreatedChart, "games_created", 2);
    }


</script>
</body>
</html>
